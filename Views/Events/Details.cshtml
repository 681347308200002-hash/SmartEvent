@model SmartEvent.Models.Event

@functions {
    string Stars(int rating)
    {
        rating = Math.Clamp(rating, 0, 5);
        return new string('★', rating) + new string('☆', 5 - rating);
    }
}

@{
    ViewData["Title"] = "Details";
}

<h1>Details</h1>

<div>
    <h4>Event</h4>

    @if (Model.Reviews != null && Model.Reviews.Any())
    {
        var avg = Model.Reviews.Average(r => r.Rating);
        var avgRounded = (int)Math.Round(avg, MidpointRounding.AwayFromZero);

        <div class="mb-2">
            <strong>Average Rating:</strong> @avg.ToString("0.0") / 5
            <span style="font-size:18px;">@Stars(avgRounded)</span>
            <span class="text-muted">(@Model.Reviews.Count review(s))</span>
        </div>
    }
    else
    {
        <p class="text-muted">No reviews yet.</p>
    }

    <hr />
    <dl class="row">
        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.EventName)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.EventName)</dd>

        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Category)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.Category)</dd>

        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.EventDate)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.EventDate)</dd>

        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Location)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.Location)</dd>

        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.BasePrice)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.BasePrice)</dd>

        <dt class="col-sm-2">@Html.DisplayNameFor(model => model.Description)</dt>
        <dd class="col-sm-10">@Html.DisplayFor(model => model.Description)</dd>
    </dl>
</div>

<div class="mt-3">
    @if (User.IsInRole("Admin"))
    {
        <a class="btn btn-warning" asp-action="Edit" asp-route-id="@Model.EventId">Edit</a>
    }

    @if (User.IsInRole("Admin"))
    {
        <a class="btn btn-secondary ms-2" asp-controller="Events" asp-action="Index">← Back to Event List</a>
    }
    else
    {
        <a class="btn btn-primary ms-2" asp-controller="Home" asp-action="Index">← Back to Home</a>
    }

    @if (User.IsInRole("Member"))
    {
        <a class="btn btn-success ms-2" asp-controller="Purchase" asp-action="Buy" asp-route-id="@Model.EventId">
            Buy Ticket
        </a>

        @if (!(ViewBag.AlreadyReviewed ?? false))
        {
            <a class="btn btn-warning ms-2" asp-controller="Reviews" asp-action="Create" asp-route-eventId="@Model.EventId">
                Write Review
            </a>
        }
    }
</div>

<hr />

<h4>Reviews</h4>

@if (User.IsInRole("Member"))
{
    if ((ViewBag.HasPurchased ?? false) && !(ViewBag.AlreadyReviewed ?? false))
    {
        <a class="btn btn-warning ms-2"
           asp-controller="Reviews"
           asp-action="Create"
           asp-route-eventId="@Model.EventId">
            Write Review
        </a>
    }
    else if (!(ViewBag.HasPurchased ?? false))
    {
        <span class="text-muted ms-2">Purchase a ticket to write a review.</span>
    }
}
else if (!(ViewBag.HasPurchased ?? false))
{
    <span class="text-muted ms-2">Purchase a ticket to write a review.</span>
}
else
{
    <p class="text-muted">No reviews yet.</p>
}
