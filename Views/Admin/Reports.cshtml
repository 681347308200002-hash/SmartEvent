@model SmartEvent.ViewModels.Admin.AdminDashboardVM
@{
    ViewData["Title"] = "Reports";

    var last7From = DateTime.UtcNow.AddDays(-7).ToString("yyyy-MM-dd");
    var today = DateTime.UtcNow.ToString("yyyy-MM-dd");
    var thisMonthFrom = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1).ToString("yyyy-MM-dd");
    var thisYearFrom = new DateTime(DateTime.UtcNow.Year, 1, 1).ToString("yyyy-MM-dd");
}

<h1>Reports</h1>

<form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-3">
        <label class="form-label">From</label>
        <input type="date" name="from" class="form-control"
               value="@Model.From.ToString("yyyy-MM-dd")" />
    </div>

    <div class="col-md-3">
        <label class="form-label">To</label>
        <input type="date" name="to" class="form-control"
               value="@Model.To.ToString("yyyy-MM-dd")" />
    </div>

    <div class="col-md-6 d-flex gap-2 flex-wrap">
        <button class="btn btn-primary" type="submit">Apply</button>

        <a class="btn btn-outline-secondary"
           asp-action="Reports"
           asp-route-from="@last7From"
           asp-route-to="@today">Last 7 Days</a>

        <a class="btn btn-outline-secondary"
           asp-action="Reports"
           asp-route-from="@thisMonthFrom"
           asp-route-to="@today">This Month</a>

        <a class="btn btn-outline-secondary"
           asp-action="Reports"
           asp-route-from="@thisYearFrom"
           asp-route-to="@today">This Year</a>

        <a class="btn btn-success"
           asp-action="ExportSalesCsv"
           asp-route-from="@Model.From.ToString("yyyy-MM-dd")"
           asp-route-to="@Model.To.ToString("yyyy-MM-dd")">
            Export CSV
        </a>
    </div>
</form>

<div class="row g-3 mt-1">

    <div class="col-md-6">
        <div class="card p-3">
            <h5>Monthly Revenue</h5>
            <canvas id="monthlyRevenueChart" height="120"></canvas>

            <hr />
            <h6 class="mt-2">Monthly Sales Details</h6>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th class="text-end">Revenue</th>
                        <th class="text-end">Tickets</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in Model.MonthlySales)
                    {
                        <tr>
                            <td>@($"{m.Year}-{m.Month:00}")</td>
                            <td class="text-end">@m.Revenue.ToString("N2")</td>
                            <td class="text-end">@m.Tickets</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card p-3">
            <h5>Top Events (by Revenue)</h5>
            <canvas id="topEventsChart" height="120"></canvas>

            <hr />
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Category</th>
                        <th class="text-end">Revenue</th>
                        <th class="text-end">Tickets</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var e in Model.TopEvents)
                    {
                        <tr>
                            <td>@e.EventName</td>
                            <td>@e.Category</td>
                            <td class="text-end">@e.Revenue.ToString("N2")</td>
                            <td class="text-end">@e.Tickets</td>
                        </tr>
                    }
                </tbody>
            </table>

            <h5 class="mt-3">Top Members (by Revenue)</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Member</th>
                        <th class="text-end">Revenue</th>
                        <th class="text-end">Tickets</th>
                        <th class="text-end">Purchases</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var u in Model.TopMembers)
                    {
                        <tr>
                            <td>@u.UserNameOrEmail</td>
                            <td class="text-end">@u.Revenue.ToString("N2")</td>
                            <td class="text-end">@u.Tickets</td>
                            <td class="text-end">@u.Purchases</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="alert alert-light border">
    Showing reports from <b>@Model.From.ToString("yyyy-MM-dd")</b> to <b>@Model.To.ToString("yyyy-MM-dd")</b>
</div>
@section Scripts {
    <script>
        const monthlyLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MonthlyLabels));
        const monthlyRevenue = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MonthlyRevenueSeries));

        const topEventLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TopEventLabels));
        const topEventRevenue = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TopEventRevenueSeries));

        new Chart(document.getElementById('monthlyRevenueChart'), {
            type: 'line',
            data: {
                labels: monthlyLabels,
                datasets: [{
                    label: 'Revenue',
                    data: monthlyRevenue,
                    tension: 0.3
                }]
            }
        });

        new Chart(document.getElementById('topEventsChart'), {
            type: 'bar',
            data: {
                labels: topEventLabels,
                datasets: [{
                    label: 'Revenue',
                    data: topEventRevenue
                }]
            }
        });
    </script>
}
